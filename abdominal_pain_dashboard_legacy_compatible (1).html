<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Abdominal Pain Assessment Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; color: #2d3748; line-height: 1.6; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .header-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 1.8rem; font-weight: 600; }
    .generate-btn { background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; }
    .generate-btn:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }

    .dashboard { max-width: 1200px; margin: 0 auto; padding: 30px 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 20px; }
    .card { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border: 1px solid #e2e8f0; overflow: hidden; transition: all 0.3s ease; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.12); }
    .card-header { background: #f8fafc; padding: 15px 20px; border-bottom: 1px solid #e2e8f0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.3s ease; }
    .card-header:hover { background: #edf2f7; }
    .card-header h3 { font-size: 1.1rem; font-weight: 600; color: #2d3748; }
    .card-icon { font-size: 1.2rem; transition: transform 0.3s ease; }
    .card.collapsed .card-icon { transform: rotate(-90deg); }
    .card-content { padding: 20px; display: block; }
    .card.collapsed .card-content { display: none; }

    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-weight: 500; color: #4a5568; margin-bottom: 5px; font-size: 0.9rem; }
    input[type="text"], input[type="number"], textarea { width: 100%; padding: 8px 12px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 0.9rem; transition: all 0.3s ease; background: #fff; }
    input[type="text"]:focus, input[type="number"]:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
    textarea { resize: vertical; min-height: 60px; }

    .symptom-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 8px; margin-top: 10px; }
    .symptom-toggle { background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px 12px; cursor: pointer; transition: all 0.3s ease; font-size: 0.85rem; text-align: center; user-select: none; }
    .symptom-toggle:hover { background: #edf2f7; border-color: #cbd5e0; }
    .symptom-toggle.have { background: #667eea; color: white; border-color: #667eea; }
    .symptom-toggle.donthave { background: #e53e3e; color: white; border-color: #e53e3e; }

    .ux-instruction { background: #fefcbf; border: 1px solid #faf089; color: #744210; padding: 10px 12px; border-radius: 8px; font-size: 0.9rem; margin-bottom: 10px; }
    .legend { display:flex; gap:10px; align-items:center; margin-top:6px; font-size:0.85rem; }
    .legend span { padding:4px 8px; border-radius:6px; }
    .legend .neutral { background:#f7fafc; border:1px solid #e2e8f0; }
    .legend .have { background:#667eea; color:white; }
    .legend .donthave { background:#e53e3e; color:white; }

    .output-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .output-content { background: white; max-width: 800px; max-height: 80vh; margin: 20px; border-radius: 12px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
    .output-header { background: #667eea; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
    .output-body { padding: 20px; max-height: 60vh; overflow-y: auto; }
    .output-text { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.9rem; line-height: 1.5; margin-bottom: 20px; }
  </style>
</head>
<body>
  <!-- Keep a form so we can append legacy mirror for generateOutput compatibility -->
  <form id="symptomForm" onsubmit="event.preventDefault(); generateOutput();"></form>

  <div class="header">
    <div class="header-content">
      <h1>Abdominal Pain Assessment Dashboard</h1>
      <button class="generate-btn" type="button" onclick="generateOutput()">Generate Report</button>
    </div>
  </div>

  <div class="dashboard">
    <!-- Initial Information Card -->
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)"><h3>Initial Information</h3><span class="card-icon">▼</span></div>
      <div class="card-content">
        <div class="form-group">
          <label>When did symptoms start and duration?</label>
          <textarea id="description" placeholder="Describe onset and duration..."></textarea>
        </div>
        <div class="form-group">
          <label>Last menstrual period</label>
          <input type="text" id="lastPeriod" placeholder="e.g., 2 weeks ago" />
        </div>
      </div>
    </div>

    <!-- Pain Assessment Card -->
    <div class="card">
      <div class="card-header" onclick="toggleCard(this)"><h3>Pain Details</h3><span class="card-icon">▼</span></div>
      <div class="card-content">
        <div class="form-group"><label>Pain location</label><input type="text" id="painLocation" placeholder="Where is the pain?" /></div>
        <div class="form-group"><label>Pain radiation</label><input type="text" id="painRadiation" placeholder="Does it spread elsewhere?" /></div>
        <div class="form-group"><label>Pain character</label><input type="text" id="painCharacter" placeholder="Sharp, dull, cramping..." /></div>
        <div class="form-group"><label>What makes it worse?</label><input type="text" id="painWorsen" placeholder="Movement, eating..." /></div>
        <div class="form-group"><label>What helps?</label><input type="text" id="painRelief" placeholder="Rest, heat, medication..." /></div>
        <div class="form-group"><label>Pain severity (1-10)</label><input type="number" id="painSeverity" min="1" max="10" /></div>
      </div>
    </div>

    <!-- Red Flag Symptoms Card -->
    <div class="card" data-grid="redFlagGrid">
      <div class="card-header" onclick="toggleCard(this)"><h3>⚠️ Urgent Warning Signs</h3><span class="card-icon">▼</span></div>
      <div class="card-content">
        <div class="ux-instruction">Tap symptoms to cycle through states:
          <div class="legend"><span class="neutral">Neutral</span><span class="have">Have</span><span class="donthave">Don’t Have</span></div>
        </div>
        <div class="symptom-grid" id="redFlagGrid">
          <div class="symptom-toggle" data-symptom="rigid abdomen">Rigid abdomen</div>
          <div class="symptom-toggle" data-symptom="bloody stool">Bloody stool</div>
          <div class="symptom-toggle" data-symptom="dark vomitus">Dark vomit</div>
          <div class="symptom-toggle" data-symptom="blood in vomitus">Blood in vomit</div>
          <div class="symptom-toggle" data-symptom="unexplained weight loss">Weight loss</div>
          <div class="symptom-toggle" data-symptom="jaundice">Jaundice</div>
          <div class="symptom-toggle" data-symptom="abdominal swelling">Abdominal swelling</div>
          <div class="symptom-toggle" data-symptom="inability to pass stool">Can’t pass stool</div>
          <div class="symptom-toggle" data-symptom="inability to pass stool and gas">Can’t pass stool/gas</div>
          <div class="symptom-toggle" data-symptom="chest pain">Chest pain</div>
          <div class="symptom-toggle" data-symptom="shortness of breath">Shortness of breath</div>
          <div class="symptom-toggle" data-symptom="pain following an injury">Pain after injury</div>
          <div class="symptom-toggle" data-symptom="cold, clammy skin">Cold, clammy skin</div>
          <div class="symptom-toggle" data-symptom="shallow breathing">Shallow breathing</div>
          <div class="symptom-toggle" data-symptom="rapid heartbeat">Rapid heartbeat</div>
        </div>
      </div>
    </div>

    <!-- Common Symptoms Card -->
    <div class="card" data-grid="commonGrid">
      <div class="card-header" onclick="toggleCard(this)"><h3>Common Symptoms</h3><span class="card-icon">▼</span></div>
      <div class="card-content">
        <div class="ux-instruction">Tap symptoms to cycle through states:
          <div class="legend"><span class="neutral">Neutral</span><span class="have">Have</span><span class="donthave">Don’t Have</span></div>
        </div>
        <div class="symptom-grid" id="commonGrid">
          <div class="symptom-toggle" data-symptom="fever">Fever</div>
          <div class="symptom-toggle" data-symptom="loss of appetite">Loss of appetite</div>
          <div class="symptom-toggle" data-symptom="nausea">Nausea</div>
          <div class="symptom-toggle" data-symptom="vomiting">Vomiting</div>
          <div class="symptom-toggle" data-symptom="bloating">Bloating</div>
          <div class="symptom-toggle" data-symptom="back pain">Back pain</div>
          <div class="symptom-toggle" data-symptom="diarrhea">Diarrhea</div>
          <div class="symptom-toggle" data-symptom="constipation">Constipation</div>
        </div>
      </div>
    </div>

    <!-- Bowel & Urinary Symptoms Card -->
    <div class="card" data-grid="additionalGrid">
      <div class="card-header" onclick="toggleCard(this)"><h3>Bowel & Urinary Symptoms</h3><span class="card-icon">▼</span></div>
      <div class="card-content">
        <div class="ux-instruction">Tap symptoms to cycle through states:
          <div class="legend"><span class="neutral">Neutral</span><span class="have">Have</span><span class="donthave">Don’t Have</span></div>
        </div>
        <div class="symptom-grid" id="additionalGrid">
          <div class="symptom-toggle" data-symptom="pale stool">Pale stool</div>
          <div class="symptom-toggle" data-symptom="not passing gas">Can’t pass gas</div>
          <div class="symptom-toggle" data-symptom="abdominal distension">Abdominal distension</div>
          <div class="symptom-toggle" data-symptom="hematuria">Blood in urine</div>
          <div class="symptom-toggle" data-symptom="dysuria">Pain urinating</div>
          <div class="symptom-toggle" data-symptom="frequency">Frequent urination</div>
          <div class="symptom-toggle" data-symptom="foul smelling urine">Smelly urine</div>
          <div class="symptom-toggle" data-symptom="melena">Black, tarry stool</div>
        </div>
      </div>
    </div>

    <!-- Reproductive Health Card -->
    <div class="card" data-grid="reproductiveGrid">
      <div class="card-header" onclick="toggleCard(this)"><h3>Reproductive Health</h3><span class="card-icon">▼</span></div>
      <div class="card-content">
        <div class="ux-instruction">Tap symptoms to cycle through states:
          <div class="legend"><span class="neutral">Neutral</span><span class="have">Have</span><span class="donthave">Don’t Have</span></div>
        </div>
        <div class="symptom-grid" id="reproductiveGrid">
          <div class="symptom-toggle" data-symptom="testicular pain">Testicular pain</div>
          <div class="symptom-toggle" data-symptom="urethral discharge">Urethral discharge</div>
          <div class="symptom-toggle" data-symptom="vaginal discharge">Vaginal discharge</div>
          <div class="symptom-toggle" data-symptom="dyspareunia">Pain during sex</div>
          <div class="symptom-toggle" data-symptom="being sexually active">Sexually active</div>
          <div class="symptom-toggle" data-symptom="using contraception">Using contraception</div>
          <div class="symptom-toggle" data-symptom="doing a home pregnancy test">Did pregnancy test</div>
          <div class="symptom-toggle" data-symptom="positive pregnancy test">Positive pregnancy test</div>
          <div class="symptom-toggle" data-symptom="abdominal pain every time periods begin">Pain with periods</div>
          <div class="symptom-toggle" data-symptom="vaginal bleeding with clots">Bleeding with clots</div>
          <div class="symptom-toggle" data-symptom="vaginal bleeding with fetal tissue">Bleeding with tissue</div>
        </div>
      </div>
    </div>

    <!-- Medical History Card -->
    <div class="card" data-grid="historyGrid">
      <div class="card-header" onclick="toggleCard(this)"><h3>Medical History</h3><span class="card-icon">▼</span></div>
      <div class="card-content">
        <div class="ux-instruction">Tap symptoms to cycle through states:
          <div class="legend"><span class="neutral">Neutral</span><span class="have">Have</span><span class="donthave">Don’t Have</span></div>
        </div>
        <div class="symptom-grid" id="historyGrid">
          <div class="symptom-toggle" data-symptom="irritable bowel disease">IBS</div>
          <div class="symptom-toggle" data-symptom="inflammatory bowel disease">IBD</div>
          <div class="symptom-toggle" data-symptom="diverticulosis">Diverticulosis</div>
          <div class="symptom-toggle" data-symptom="pancreatitis">Pancreatitis</div>
          <div class="symptom-toggle" data-symptom="gallstones">Gallstones</div>
          <div class="symptom-toggle" data-symptom="appendicitis">Appendicitis</div>
          <div class="symptom-toggle" data-symptom="abdominal surgery">Abdominal surgery</div>
          <div class="symptom-toggle" data-symptom="pelvic surgery">Pelvic surgery</div>
          <div class="symptom-toggle" data-symptom="AAA (Abdominal Aortic Aneurysm)">AAA</div>
          <div class="symptom-toggle" data-symptom="endometritis">Endometritis</div>
          <div class="symptom-toggle" data-symptom="ectopic pregnancy">Ectopic pregnancy</div>
          <div class="symptom-toggle" data-symptom="peptic ulcers">Peptic ulcers</div>
          <div class="symptom-toggle" data-symptom="diabetes">Diabetes</div>
          <div class="symptom-toggle" data-symptom="sickle cell disease">Sickle cell</div>
          <div class="symptom-toggle" data-symptom="kidney stones">Kidney stones</div>
          <div class="symptom-toggle" data-symptom="ischemic bowel disease">Ischemic bowel</div>
          <div class="symptom-toggle" data-symptom="food allergy">Food allergy</div>
        </div>
      </div>
    </div>
  </div>

  <pre id="output-container" style="white-space: pre-wrap; max-width:1200px; margin: 10px auto; padding: 0 20px;"></pre>

  <script>
    function toggleCard(header){ header.parentElement.classList.toggle('collapsed'); }
  </script>

  <!-- ===== Legacy-compatible functions (unchanged behavior) ===== -->
  <script>
    function capitalizeAndAddFullStop(text) { if (!text) return ''; return text.charAt(0).toUpperCase() + text.slice(1) + (text.endsWith('.') ? '' : '.'); }
    function formatCheckboxText(column, checked) {
      let text = '';
      for (let i = 0; i < checked.length; i++) {
        text += checked[i];
        if (i === checked.length - 1) {
          text += '.';
        } else if ((column === 1 && i === 0) || (column === 2 && i === 0)) {
          text += ' ';
        } else if (i === checked.length - 2) {
          if (column === 2) {
            let firstWord = 'or';
            if (i > 0) {
              const lastInput = checked[i-1] || '';
              firstWord = lastInput.trim().split(' ')[0].toLowerCase();
            }
            text += firstWord === 'no' ? ' and ' : ' or ';
          } else {
            text += ' and ';
          }
        } else if (checked.length > 1 && i < checked.length - 1) {
          text += ', ';
        }
      }
      if (column === 2) { text = text.trim() + '\n'; }
      return text;
    }

    function generateOutput() {
      return new Promise(resolve => {
        const outputContainer = document.getElementById('output-container');
        let outputText = '';

        const sections = Array.from(document.getElementsByClassName('form-section')).sort((a, b) => {
          return parseInt(a.id) - parseInt(b.id);
        });

        sections.forEach(section => {
          const description = section.querySelector('textarea:not([data-associated-checkbox])');
          if (description && description.value.trim()) {
            outputText += capitalizeAndAddFullStop(description.value.trim()) + '\n';
          }

          if (section.id === "mixed") {
            const inputFields = section.querySelectorAll('input[type="text"], input[type="number"]');
            inputFields.forEach(input => {
              if (input.value.trim()) { outputText += input.id + ' ' + input.value.trim() + '\n'; }
            });
          }

          const column1Checkboxes = section.querySelectorAll('input.column-1-symptom-checkbox');
          const column2Checkboxes = section.querySelectorAll('input.column-2-symptom-checkbox');

          const column1Checked = [];
          const column2Checked = [];

          column1Checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
              const textareaId = checkbox.getAttribute('data-textarea');
              const textarea = textareaId ? document.getElementById(textareaId) : null;
              const associatedText = textarea && textarea.value.trim() ? ' ' + textarea.value.trim() : '';
              column1Checked.push(checkbox.id + associatedText);
            }
          });

          column2Checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
              const textareaId = checkbox.getAttribute('data-textarea');
              const textarea = textareaId ? document.getElementById(textareaId) : null;
              const associatedText = textarea && textarea.value.trim() ? ' ' + textarea.value.trim() : '';
              column2Checked.push(checkbox.id + associatedText);
            }
          });

          if (column1Checked.length > 0) { outputText += formatCheckboxText(1, column1Checked); }
          if (column2Checked.length > 0) { const formattedText = formatCheckboxText(2, column2Checked); outputText += '\n' + formattedText; }
        });

        outputContainer.innerHTML = outputText.trim();
        resolve();
      });
    }
  </script>

  <!-- ===== Dashboard → Legacy adapter (tri-state pills → legacy checkboxes, auto-headers) ===== -->
  <script>
    (function(){
      // Map data-symptom (exact legacy IDs preferred)
      const LEGACY_ID = {
        // red flags
        'rigid abdomen':'rigid abdomen','bloody stool':'bloody stool','dark vomitus':'dark vomitus','blood in vomitus':'blood in vomitus','unexplained weight loss':'unexplained weight loss','jaundice':'jaundice','abdominal swelling':'abdominal swelling','inability to pass stool':'inability to pass stool','inability to pass stool and gas':'inability to pass stool and gas','chest pain':'chest pain','shortness of breath':'shortness of breath','pain following an injury':'pain following an injury','cold, clammy skin':'cold, clammy skin','shallow breathing':'shallow breathing','rapid heartbeat':'rapid heartbeat',
        // common
        'fever':'fever','loss of appetite':'loss of appetite','nausea':'nausea','vomiting':'vomiting','bloating':'bloating','back pain':'back pain','diarrhea':'diarrhea','constipation':'constipation',
        // additional
        'pale stool':'Pale stool','not passing gas':'not passing gas','abdominal distension':'abdominal distension','hematuria':'hematuria','dysuria':'dysuria','frequency':'frequency','foul smelling urine':'foul smelling urine','melena':'melena',
        // reproductive
        'testicular pain':'testicular pain','urethral discharge':'urethral discharge','vaginal discharge':'vaginal discharge','dyspareunia':'dyspareunia','being sexually active':'being sexually active','using contraception':'using contraception','doing a home pregnancy test':'doing a home pregnancy test','positive pregnancy test':'positive pregnancy test','abdominal pain every time periods begin':'abdominal pain every time periods begin','vaginal bleeding with clots':'vaginal bleeding with clots','vaginal bleeding with fetal tissue':'vaginal bleeding with fetal tissue',
        // history
        'irritable bowel disease':'irritable bowel disease','inflammatory bowel disease':'inflammatory bowel disease','diverticulosis':'diverticulosis','pancreatitis':'pancreatitis','gallstones':'gallstones','appendicitis':'appendicitis','abdominal surgery':'abdominal surgery','pelvic surgery':'pelvic surgery','aaa (abdominal aortic aneurysm)':'AAA (Abdominal Aortic Aneurysm)','endometritis':'endometritis','ectopic pregnancy':'ectopic pregnancy','peptic ulcers':'peptic ulcers','diabetes':'diabetes','sickle cell disease':'sickle cell disease','kidney stones':'kidney stones','ischemic bowel disease':'ischemic bowel disease','food allergy':'food allergy'
      };

      const GROUP_HEADERS = {
        redFlagGrid:   { col1: 'Reports',             col2: 'Reports' },
        commonGrid:    { col1: 'Complaining of',      col2: 'Has' },
        additionalGrid:{ col1: 'Reports',             col2: 'Reports' },
        reproductiveGrid:{col1: 'Reports',            col2: 'Reports' },
        historyGrid:   { col1: 'Has a history of',    col2: 'Has no history of' },
      };

      const legacy = document.createElement('div');
      legacy.id = 'legacy-mirror';
      legacy.style.display = 'none';

      const sections = { s1: mkSection('1'), s2: mkSection('2'), red: mkSection('3'), com: mkSection('4'), add: mkSection('5'), rep: mkSection('6'), his: mkSection('7') };

      // s1 free text & LMP
      sections.s1.append( mkTextarea('description'), mkText('Last menstrual period-') );
      // s2 pain block
      sections.s2.append( mkText('Pain located in'), mkText('Radiates to'), mkText('Character of pain is'), mkText('Pain is associated with'), mkText('Alleviated by'), mkText('Pain is exacerbated by'), mkText('Pain severity -') );

      document.addEventListener('DOMContentLoaded', () => {
        // Attach legacy sections
        const form = document.getElementById('symptomForm') || document.body;
        Object.values(sections).forEach(sec => legacy.appendChild(sec));
        form.appendChild(legacy);

        // Build mirrored groups for each grid
        ['redFlagGrid','commonGrid','additionalGrid','reproductiveGrid','historyGrid'].forEach(gridId=>{
          const items = collectItems(gridId);
          addGroup(sectionForGrid(gridId), gridId, items);
        });

        // Tri-state behavior across ALL grids
        document.querySelectorAll('.symptom-toggle').forEach(pill => {
          pill.addEventListener('click', () => {
            cycleTriState(pill); // UI cycle
            syncPillToLegacy(pill); // mirror to legacy checkbox
            updateHeadersForGrid(closestGridId(pill)); // auto header once per column
          });
        });

        // Sync pretty inputs → legacy IDs
        wireInputs();
      });

      function mkSection(id){ const s=document.createElement('div'); s.className='form-section'; s.id=id; return s; }
      function mkCheckbox(id, cls){ const i=document.createElement('input'); i.type='checkbox'; i.id=id; i.className=cls; return i; }
      function mkText(id){ const i=document.createElement('input'); i.type='text'; i.id=id; return i; }
      function mkTextarea(id){ const t=document.createElement('textarea'); t.id=id; return t; }
      function cssEscape(id){ return (window.CSS && CSS.escape) ? CSS.escape(id) : id.replace(/([ #.;,()%&!+])/g,'\\$1'); }

      function collectItems(gridId){
        const grid = document.getElementById(gridId); if(!grid) return [];
        const items=[]; grid.querySelectorAll('.symptom-toggle').forEach(t=>{ const key = normalizeKey(t.dataset.symptom); const legacyId = LEGACY_ID[key]; if(!legacyId) return; items.push(legacyId); });
        return items;
      }

      function addGroup(sec, gridId, legacyIds){
        const headers = GROUP_HEADERS[gridId];
        // Column headers (auto-checked later)
        sec.append( mkCheckbox(headers.col1, 'column-1-symptom-checkbox'), mkCheckbox(headers.col2, 'column-2-symptom-checkbox') );
        // Items: add both positive and negative IDs (column 1 and 2)
        legacyIds.forEach(legacyId => {
          sec.append( mkCheckbox(legacyId, 'column-1-symptom-checkbox') );
          sec.append( mkCheckbox(makeNegativeId(legacyId), 'column-2-symptom-checkbox') );
        });
      }

      function cycleTriState(el){
        if (el.classList.contains('have')) { el.classList.remove('have'); el.classList.add('donthave'); }
        else if (el.classList.contains('donthave')) { el.classList.remove('donthave'); }
        else { el.classList.add('have'); }
      }

      function syncPillToLegacy(pill){
        const key = normalizeKey(pill.dataset.symptom); const base = LEGACY_ID[key]; if(!base) return;
        const posId = base; const negId = makeNegativeId(base);
        // neutral clears both; have checks pos; donthave checks neg
        if (!pill.classList.contains('have') && !pill.classList.contains('donthave')) {
          setLegacyChecked(posId, false); setLegacyChecked(negId, false);
        } else if (pill.classList.contains('have')) {
          setLegacyChecked(posId, true); setLegacyChecked(negId, false);
        } else { // donthave
          setLegacyChecked(posId, false); setLegacyChecked(negId, true);
        }
      }

      function wireInputs(){
        const map = [
          ['description', 'description', 'textarea'], ['lastPeriod', 'Last menstrual period-'],
          ['painLocation','Pain located in'], ['painRadiation','Radiates to'], ['painCharacter','Character of pain is'],
          ['painWorsen','Pain is exacerbated by'], ['painRelief','Alleviated by'], ['painSeverity','Pain severity -']
        ];
        const legacyRoot = document.getElementById('legacy-mirror');
        map.forEach(([srcId, legacyId, type])=>{
          const src = document.getElementById(srcId); if(!src) return;
          let target = legacyRoot.querySelector('#'+cssEscape(legacyId));
          if(!target){ target = document.createElement(type==='textarea' ? 'textarea' : 'input'); if(type!=='textarea') target.type='text'; target.id = legacyId; const bucket = ['Pain located in','Radiates to','Character of pain is','Pain is associated with','Alleviated by','Pain is exacerbated by','Pain severity -'].includes(legacyId) ? sections.s2 : sections.s1; bucket.appendChild(target); }
          src.addEventListener('input', ()=>{ target.value = src.value; });
        });
      }

      function normalizeKey(s){ return (s||'').trim().toLowerCase().replace(/\s+/g,' '); }
      function makeNegativeId(legacyId){ if(/^no\s+/i.test(legacyId)) return legacyId; if(legacyId==='not passing gas') return 'passing gas'; return 'no ' + legacyId; }
      function setLegacyChecked(id, val){ const el = document.querySelector('#legacy-mirror #'+cssEscape(id)); if(el) el.checked = !!val; }

      function closestGridId(pill){ const card = pill.closest('.card'); return card ? card.getAttribute('data-grid') : null; }
      function sectionForGrid(gridId){ switch(gridId){ case 'redFlagGrid': return sections.red; case 'commonGrid': return sections.com; case 'additionalGrid': return sections.add; case 'reproductiveGrid': return sections.rep; case 'historyGrid': return sections.his; default: return null; } }

      function updateHeadersForGrid(gridId){ if(!gridId) return; const headers = GROUP_HEADERS[gridId]; if(!headers) return; const sec = sectionForGrid(gridId); if(!sec) return; const h1 = sec.querySelector('input.column-1-symptom-checkbox#'+cssEscape(headers.col1)); const h2 = sec.querySelector('input.column-2-symptom-checkbox#'+cssEscape(headers.col2)); const posAny = sec.querySelectorAll('input.column-1-symptom-checkbox:not(#'+cssEscape(headers.col1)+'):checked').length>0; const negAny = sec.querySelectorAll('input.column-2-symptom-checkbox:not(#'+cssEscape(headers.col2)+'):checked').length>0; if(h1) h1.checked = posAny; if(h2) h2.checked = negAny; }
    })();
  </script>
</body>
</html>
